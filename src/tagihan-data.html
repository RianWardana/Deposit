<dom-module id="tagihan-data">
    <template>
    </template>

    <script>
        (function() {
            Polymer({
                is: 'tagihan-data',
                properties: {
                    dataTagihan: { 
                        type: Array,
                        notify: true
                    },

                    // totalTagihan: {
                    //     type: Number,
                    //     value: 0,
                    //     notify: true
                    // },

                    totalPengeluaran: {
                        type: Object,
                        value: {total: 0, today: 0, makan: 0, transportasi: 0, lainnya: 0},
                        notify: true
                    },

                    dataTambah: {
                        type: Object,
                        observer: 'kirimDataTambah'
                    },

                    dataEdit: {
                        type: Object,
                        observer: 'kirimDataEdit'
                    },

                    waktu: String,
                    nama: String,
                    jumlah: String,

                    uid: {
                        type: String
                    }
                },

                ready: function() {
                    thisTagDat = this

                    auth.onAuthStateChanged(firebaseUser => {
                        if (firebaseUser) {
                            thisTagDat.uid = firebaseUser.uid
                            thisTagDat.loadTagihan()
                        }
                        else {
                            thisTagDat.dataTagihan = []
                        }
                    })
                },

                loadTagihan: function() {
                    console.log('loadTagihan')

                    dbTagihan = firebase.database().ref(thisTagDat.uid + "/tagihan")
                    dbTagihanLimited = dbTagihan.orderByChild('lunas').equalTo(0)

                    var dateObjectToday = new Date()
                    var tanggalToday = (dateObjectToday.getDate() < 10 ? "0" : "") + dateObjectToday.getDate()

                    // Tereksekusi setiap ada perubahaan di database 'tagihan' //
                    dbTagihanLimited.on('value', snap => {
                        thisTagDat.dataTagihan = []
                        thisTagDat.totalTagihan = 0
                        var total = 0
                        var today = 0
                        var totalMakan = 0
                        var totalTransportasi = 0
                        var totalLainnya = 0
                        // Tereksekusi untuk setiap entri di 'tagihan' //
                        snap.forEach(snapEach => {
                            var dateObject = new Date(parseInt(snapEach.key)*(-1000))
                            var tanggal = (dateObject.getDate() < 10 ? "0" : "") + dateObject.getDate()
                            var bulan = (dateObject.getMonth() < 9 ? "0" : "") + (dateObject.getMonth() + 1)
                            var tahun = dateObject.getYear() - 100
                            var waktu = tanggal + "/" + bulan + "/" + tahun
                            var nama = snapEach.val()['nama']
                            var jumlah = snapEach.val()['jumlah']

                            // Perhitungan
                            total += jumlah

                            if (tanggal == tanggalToday) 
                                today += jumlah

                            if ((nama == "Makan") || (nama == "Minum") || (nama == "Go-Food") || (nama == "GrabFood") || (nama == "Sereal"))
                                totalMakan += jumlah

                            else if ((nama == "Transportasi") || (nama == "e-Money") || (nama == "Parkir") || (nama == "Go-Jek Subs") || (nama == "Grab Subs") || (nama == "Go-Ride") || (nama == "GrabRide") || (nama == "Go-Car") || (nama == "GrabCar"))
                                totalTransportasi += jumlah

                            else totalLainnya += jumlah
                            
                            thisTagDat.totalPengeluaran = {
                                transportasi: totalTransportasi,
                                makan: totalMakan,
                                lainnya: totalLainnya,
                                today: today,
                                total: total
                            }

                            thisTagDat.push('dataTagihan', {
                                key: snapEach.key,
                                waktu: waktu,
                                nama: nama,
                                jumlah: jumlah
                            })
                        })
                    })
                },

                kirimDataTambah: function() {
                    var ini = this

                    var epoch = Math.floor(new Date() / -1000)
                    
                    var data = {
                        nama: ini.dataTambah['nama'],
                        jumlah: parseInt(ini.dataTambah['jumlah']),
                        lunas: 0
                    }

                    var submission = dbTagihan.child(epoch).set(data)
                    submission.then(e => {
                        console.log("Penambahan berhasil.")
                    })
                    submission.catch(e => console.log(e.message))
                },

                kirimDataEdit: function() {
                    var ini = this
                    
                    var data = {
                        nama: ini.dataEdit['nama'],
                        jumlah: parseInt(ini.dataEdit['jumlah']),
                        lunas: 0
                    }

                    if (ini.dataEdit['jumlah'] == 0) dbTagihan.child(ini.dataEdit['key']).remove()
                    else {
                        var submission = dbTagihan.child(ini.dataEdit['key']).set(data)
                        submission.then(e => {
                            console.log("Edit berhasil.")
                        })
                        submission.catch(e => console.log(e.message))
                    }  
                },

                lunasiSemua: function() {
                    thisTagDat.dataTagihan.forEach(tagihan => {
                        console.log(tagihan.key)
                        dbTagihan.child(tagihan.key).update({lunas: 1})
                    })
                }

            });
        })();
    </script>
</dom-module>